name: Build ZMK Firmware

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main

  post-build-diagnostics:
    name: Post Build Diagnostics
    needs: [build]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Download full build logs
        uses: actions/download-artifact@v4
        with:
          name: logs
          path: logs

      - name: Generate summary
        run: |
          echo "🧱 **ZMK Build Diagnostics**" > summary.txt
          echo "" >> summary.txt
          echo "Here’s the tail of the failing build log for easier review:" >> summary.txt
          echo "" >> summary.txt
          tail -n 50 $(find logs -type f | head -n 1) >> summary.txt || echo "⚠️ No log file found" >> summary.txt

      - name: Post comment on PR or commit
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: zmk-diagnostics
          path: summary.txt
